<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Discover Skills - SkillSwap</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
body {
  background: linear-gradient(135deg, #667eea, #764ba2);
  min-height: 100vh;
  margin: 0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* TOP NAVBAR */
.top-navbar {
  background: white;
  padding: 15px 30px;
  box-shadow: 0 2px 15px rgba(0,0,0,0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  z-index: 100;
}
.navbar-brand {
  font-size: 1.5rem;
  font-weight: 800;
  background: linear-gradient(135deg, #667eea, #764ba2);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}
.top-nav-actions {
  display: flex;
  align-items: center;
  gap: 10px;
}
.ai-nav-link {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  border: none;
  padding: 10px 16px;
  border-radius: 10px;
  font-weight: 700;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  transition: all 0.25s;
}
.ai-nav-link:hover {
  color: white;
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
}
.profile-trigger {
  display: flex;
  align-items: center;
  gap: 12px;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  padding: 10px 20px;
  border-radius: 25px;
  cursor: pointer;
  transition: all 0.3s;
  border: none;
  font-weight: 600;
}
.profile-trigger:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}
.profile-avatar-small {
  width: 35px;
  height: 35px;
  border-radius: 50%;
  background: white;
  color: #667eea;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
}

/* SLIDING PROFILE SIDEBAR (RIGHT) */
.profile-sidebar {
  position: fixed;
  right: -350px;
  top: 0;
  width: 350px;
  height: 100vh;
  background: white;
  box-shadow: -5px 0 25px rgba(0,0,0,0.2);
  transition: right 0.3s ease-in-out;
  z-index: 1000;
  overflow-y: auto;
}
.profile-sidebar.open {
  right: 0;
}
.profile-sidebar-header {
  background: linear-gradient(135deg, #667eea, #764ba2);
  padding: 30px 20px;
  color: white;
  position: relative;
}
.close-sidebar {
  position: absolute;
  top: 15px;
  right: 15px;
  background: rgba(255,255,255,0.2);
  border: none;
  color: white;
  font-size: 1.5rem;
  width: 35px;
  height: 35px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}
.close-sidebar:hover {
  background: rgba(255,255,255,0.3);
  transform: rotate(90deg);
}
.profile-avatar-large {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: white;
  color: #667eea;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 15px;
  font-size: 2.5rem;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
.profile-name {
  font-size: 1.3rem;
  font-weight: 700;
  text-align: center;
  margin-bottom: 8px;
}
.profile-role {
  text-align: center;
  background: rgba(255,255,255,0.2);
  padding: 6px 16px;
  border-radius: 20px;
  font-size: 0.9rem;
  display: inline-block;
  width: 100%;
}
.profile-content {
  padding: 25px 20px;
}
.profile-section {
  margin-bottom: 25px;
}
.section-title {
  font-size: 0.85rem;
  font-weight: 700;
  color: #6b7280;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 12px;
}
.profile-info-item {
  background: #f9fafb;
  padding: 12px 15px;
  border-radius: 10px;
  margin-bottom: 10px;
  border-left: 3px solid #667eea;
}
.info-label {
  font-size: 0.75rem;
  color: #6b7280;
  font-weight: 600;
  margin-bottom: 4px;
}
.info-value {
  font-size: 0.95rem;
  color: #1f2937;
  font-weight: 600;
}
.profile-btn {
  width: 100%;
  padding: 12px;
  border: none;
  border-radius: 10px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s;
  margin-bottom: 10px;
  font-size: 0.95rem;
}
.btn-primary-custom {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
}
.btn-primary-custom:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}
.btn-outline-custom {
  background: white;
  color: #667eea;
  border: 2px solid #667eea;
}
.btn-outline-custom:hover {
  background: #f3f4f6;
}
.btn-danger-custom {
  background: #ef4444;
  color: white;
}

/* OVERLAY */
.sidebar-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 999;
  display: none;
}
.sidebar-overlay.show {
  display: block;
}

/* MAIN CONTENT */
.main-content {
  padding: 30px 20px;
  max-width: 1400px;
  margin: 0 auto;
}
.page-header {
  text-align: center;
  margin-bottom: 40px;
}
.page-header h1 {
  color: white;
  font-size: 2.8rem;
  font-weight: 900;
  margin-bottom: 15px;
  text-shadow: 0 2px 10px rgba(0,0,0,0.2);
}
.page-header p {
  color: rgba(255,255,255,0.95);
  font-size: 1.2rem;
}
.search-card {
  background: white;
  border-radius: 20px;
  padding: 35px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.2);
  margin-bottom: 30px;
}
.shortcuts-toggle {
  width: 100%;
  margin-bottom: 18px;
  padding: 12px 16px;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  background: #f9fafb;
  color: #374151;
  font-weight: 700;
  text-align: left;
  cursor: pointer;
}
.shortcuts-toggle:hover {
  border-color: #c7d2fe;
  background: #f3f4f6;
}
.shortcuts-panel {
  display: none;
  margin-bottom: 20px;
}
.shortcuts-panel.open {
  display: block;
}
.search-input-wrapper {
  position: relative;
  margin-bottom: 30px;
}
.quick-filters-row {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  align-items: center;
  margin-bottom: 18px;
}
.quick-filters-row .form-select {
  max-width: 240px;
  border: 2px solid #e5e7eb;
  border-radius: 10px;
  font-weight: 600;
}
.quick-filters-row .form-select:focus {
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.12);
}
.active-filter-chip {
  background: #eef2ff;
  color: #4338ca;
  border-radius: 999px;
  padding: 6px 10px;
  font-size: 0.82rem;
  font-weight: 700;
}
.search-input {
  width: 100%;
  padding: 18px 60px 18px 25px;
  border: 3px solid #e5e7eb;
  border-radius: 15px;
  font-size: 1.1rem;
  transition: all 0.3s;
}
.search-input:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
}
.search-btn {
  position: absolute;
  right: 8px;
  top: 8px;
  padding: 10px 25px;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
}
.popular-section {
  margin-bottom: 30px;
}
.popular-tags {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}
.popular-tag {
  background: #dbeafe;
  color: #1e40af;
  padding: 8px 16px;
  border-radius: 20px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
.popular-tag:hover {
  background: #bfdbfe;
  transform: translateY(-2px);
}
.categories-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}
.category-card {
  background: white;
  border-radius: 15px;
  padding: 20px;
  text-align: center;
  transition: all 0.3s;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  cursor: pointer;
}
.category-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
}
.category-icon {
  font-size: 2rem;
  margin-bottom: 10px;
}
.tabs-nav {
  display: flex;
  gap: 10px;
  margin-bottom: 30px;
  flex-wrap: wrap;
  padding-bottom: 20px;
  border-bottom: 3px solid #e5e7eb;
}
.tab-btn {
  padding: 12px 28px;
  border: none;
  background: #f3f4f6;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s;
  font-weight: 600;
  font-size: 1rem;
  color: #4b5563;
}
.tab-btn.active {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  box-shadow: 0 5px 20px rgba(102, 12, 234, 0.3);
}
.skills-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 25px;
}
.skill-card {
  background: white;
  border-left: 5px solid #667eea;
  border-radius: 15px;
  padding: 25px;
  transition: all 0.3s;
  cursor: pointer;
  box-shadow: 0 4px 15px rgba(0,0,0,0.08);
}
.skill-card:hover {
  transform: translateY(-8px) scale(1.02);
  box-shadow: 0 12px 30px rgba(102, 126, 234, 0.2);
}
.skill-title {
  font-size: 1.4rem;
  font-weight: bold;
  color: #1f2937;
  margin-bottom: 10px;
}
.mentor-count {
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: 700;
  display: inline-block;
}
.view-mentors-btn {
  padding: 10px 22px;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  margin-top: 15px;
}
.load-more-btn {
  padding: 11px 26px;
  background: white;
  color: #667eea;
  border: 2px solid #667eea;
  border-radius: 10px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s ease;
}
.load-more-btn:hover {
  background: #667eea;
  color: white;
}

/* Modal */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.7);
  z-index: 9999;
  align-items: center;
  justify-content: center;
}
.modal-overlay.show {
  display: flex;
}
.modal-content {
  background: white;
  border-radius: 20px;
  padding: 40px;
  max-width: 600px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
}
.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
  padding-bottom: 20px;
  border-bottom: 2px solid #e5e7eb;
}
.close-btn {
  background: none;
  border: none;
  font-size: 2rem;
  cursor: pointer;
  color: #6b7280;
}
.form-group {
  margin-bottom: 20px;
}
.form-label {
  font-weight: 700;
  color: #374151;
  margin-bottom: 8px;
  display: block;
}
.form-control {
  width: 100%;
  padding: 12px 15px;
  border: 2px solid #e5e7eb;
  border-radius: 10px;
  font-size: 1rem;
}
.form-control:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}
</style>
</head>
<body>
<!-- Top Navbar -->
<div class="top-navbar">
  <div class="navbar-brand">üéì SkillSwap</div>
  <div class="top-nav-actions">
    <a href="/static/recommendations.html" class="ai-nav-link">ü§ñ AI Recommendations</a>
    <a href="/static/notifications.html" id="notifBellLink"
       style="position:relative; color:#667eea; margin-right:15px; font-size:1.3rem; text-decoration:none;">
      <i class="fas fa-bell"></i>
      <span id="notifCount" style="display:none; position:absolute; top:-8px; right:-8px; background:#ef4444; color:white; border-radius:50%; width:18px; height:18px; font-size:0.65rem; font-weight:700; align-items:center; justify-content:center;">0</span>
    </a>
    <button class="profile-trigger" onclick="toggleProfileSidebar()">
      <div class="profile-avatar-small" id="navAvatar">üë§</div>
      <span id="navName">User</span>
    </button>
  </div>
</div>

<!-- Sidebar Overlay -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeProfileSidebar()"></div>

<!-- Sliding Profile Sidebar (RIGHT) -->
<div class="profile-sidebar" id="profileSidebar">
  <div class="profile-sidebar-header">
    <button class="close-sidebar" onclick="closeProfileSidebar()">√ó</button>
    <div class="profile-avatar-large" id="profileAvatar">üë§</div>
    <div class="profile-name" id="profileName">Loading...</div>
    <div class="profile-role" id="profileRole">User</div>
  </div>
  <div class="profile-content">
    <!-- MENTOR PROFILE -->
    <div id="mentorProfile" style="display:none;">
      <div class="profile-section">
        <div class="section-title">üìä Profile Information</div>
        <div class="profile-info-item">
          <div class="info-label">Email</div>
          <div class="info-value" id="mentorEmail">-</div>
        </div>
        <div class="profile-info-item">
          <div class="info-label">Qualification</div>
          <div class="info-value" id="mentorQualification">-</div>
        </div>
        <div class="profile-info-item">
          <div class="info-label">Experience</div>
          <div class="info-value" id="mentorExperience">-</div>
        </div>
        <div class="profile-info-item">
          <div class="info-label">Age</div>
          <div class="info-value" id="mentorAge">-</div>
        </div>
      </div>
      <div class="profile-section">
        <div class="section-title">‚öôÔ∏è Quick Actions</div>
        <button onclick="window.location.href='/static/add-skill.html'" class="profile-btn btn-primary-custom">
          ‚ûï Add Skill
        </button>
        <button onclick="window.location.href='/static/sessions.html'" class="profile-btn btn-outline-custom">
          üìÖ My Sessions
        </button>
        <button id="mentorRatingsBtn" onclick="openMyMentorProfile()" class="profile-btn btn-outline-custom">
          ‚≠ê My Ratings & Reviews
        </button>
        <button onclick="showEditProfile()" class="profile-btn btn-outline-custom">
          ‚úèÔ∏è Edit Profile
        </button>
        <button onclick="showChangePassword()" class="profile-btn btn-outline-custom">
          üîí Change Password
        </button>
      </div>
      <div class="profile-section">
        <button onclick="logout()" class="profile-btn btn-danger-custom">
          üö™ Logout
        </button>
      </div>
    </div>

    <!-- LEARNER PROFILE -->
    <div id="learnerProfile" style="display:none;">
      <div class="profile-section">
        <div class="section-title">üìä Profile Information</div>
        <div class="profile-info-item">
          <div class="info-label">Full Name</div>
          <div class="info-value" id="learnerFullName">-</div>
        </div>
        <div class="profile-info-item">
          <div class="info-label">Email</div>
          <div class="info-value" id="learnerEmail">-</div>
        </div>
        <div class="profile-info-item">
          <div class="info-label">Institution</div>
          <div class="info-value" id="learnerInstitution">-</div>
        </div>
        <div class="profile-info-item">
          <div class="info-label">Age</div>
          <div class="info-value" id="learnerAge">-</div>
        </div>
      </div>
      <div class="profile-section">
        <div class="section-title">‚öôÔ∏è Quick Actions</div>
        <button onclick="window.location.href='/static/add-skill.html?type=learn'" class="profile-btn btn-primary-custom">
          üéØ Add Learning Skill
        </button>
        <button onclick="window.location.href='/static/sessions.html'" class="profile-btn btn-primary-custom">
          üìÖ My Sessions
        </button>
        <button onclick="showEditProfile()" class="profile-btn btn-outline-custom">
          ‚úèÔ∏è Edit Profile
        </button>
        <button onclick="showChangePassword()" class="profile-btn btn-outline-custom">
          üîí Change Password
        </button>
      </div>
      <div class="profile-section">
        <button onclick="logout()" class="profile-btn btn-danger-custom">
          üö™ Logout
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Main Content -->
<div class="main-content">
  <div class="page-header">
    <h1>üîç Discover Skills</h1>
    <p>Find the perfect mentor and start learning today</p>
  </div>

  <div class="search-card">
    <!-- Search Bar -->
    <div class="search-input-wrapper">
      <input type="text"
             id="searchInput"
             class="search-input"
             placeholder="üîé Search for any skill... (e.g., Python, Guitar)"
             onkeypress="handleSearchEnter(event)">
      <button class="search-btn" onclick="performSearch()">
        Search
      </button>
    </div>

    <div class="quick-filters-row">
      <select id="levelFilter" class="form-select" onchange="onLevelFilterChange()">
        <option value="">All levels</option>
        <option value="Beginner">Beginner</option>
        <option value="Intermediate">Intermediate</option>
        <option value="Advanced">Advanced</option>
        <option value="Expert">Expert</option>
      </select>
      <button class="btn btn-outline-secondary btn-sm" onclick="clearSearchFilters()">
        Clear filters
      </button>
      <span id="activeCategoryChip" class="active-filter-chip" style="display:none;"></span>
    </div>

    <button class="shortcuts-toggle" onclick="toggleShortcutsPanel()">
      ‚öôÔ∏è Explore More Filters (Popular, Category, Trending, Recent)
    </button>

    <div id="shortcutsPanel" class="shortcuts-panel">
      <div class="popular-section">
        <h4 class="mb-3">üî• Popular Searches</h4>
        <div class="popular-tags">
          <span class="popular-tag" onclick="quickSearch('Python')">Python</span>
          <span class="popular-tag" onclick="quickSearch('Web Design')">Web Design</span>
          <span class="popular-tag" onclick="quickSearch('Guitar')">Guitar</span>
          <span class="popular-tag" onclick="quickSearch('Marketing')">Marketing</span>
          <span class="popular-tag" onclick="quickSearch('Data Science')">Data Science</span>
        </div>
      </div>

      <div class="mb-4">
        <h4 class="mb-3">üìÇ Browse by Category</h4>
        <div class="categories-grid">
          <div class="category-card" onclick="filterByCategory('Programming')">
            <div class="category-icon">üíª</div>
            <div>Programming</div>
          </div>
          <div class="category-card" onclick="filterByCategory('Design')">
            <div class="category-icon">üé®</div>
            <div>Design</div>
          </div>
          <div class="category-card" onclick="filterByCategory('Business')">
            <div class="category-icon">üíº</div>
            <div>Business</div>
          </div>
          <div class="category-card" onclick="filterByCategory('Data Science')">
            <div class="category-icon">üìä</div>
            <div>Data Science</div>
          </div>
        </div>
      </div>

      <div class="tabs-nav">
        <button class="tab-btn active" onclick="showTab('search', event)">
          üîç Search Results
        </button>
        <button class="tab-btn" onclick="showTab('trending', event)">
          üî• Trending
        </button>
        <button class="tab-btn" onclick="showTab('recent', event)">
          üÜï Recent
        </button>
      </div>
    </div>

    <!-- Results -->
    <div id="searchTab" class="tab-content">
      <div id="skillsContainer" class="skills-grid">
        <div class="text-center py-5">
          <div class="spinner-border" role="status"></div>
          <p class="mt-3">Loading skills...</p>
        </div>
      </div>
      <div id="loadMoreContainer" class="text-center mt-4" style="display:none;">
        <button id="loadMoreBtn" class="load-more-btn" onclick="loadMoreSkills()">
          Load More
        </button>
      </div>
    </div>
    <div id="trendingTab" class="tab-content" style="display:none;">
      <div id="trendingContainer" class="skills-grid"></div>
      <div id="trendingLoadMoreContainer" class="text-center mt-4" style="display:none;">
        <button id="trendingLoadMoreBtn" class="load-more-btn" onclick="loadMoreTrendingSkills()">
          Load More
        </button>
      </div>
    </div>
    <div id="recentTab" class="tab-content" style="display:none;">
      <div id="recentContainer" class="skills-grid"></div>
      <div id="recentLoadMoreContainer" class="text-center mt-4" style="display:none;">
        <button id="recentLoadMoreBtn" class="load-more-btn" onclick="loadMoreRecentSkills()">
          Load More
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Profile Modal -->
<div id="editProfileModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h4>‚úèÔ∏è Edit Profile</h4>
      <button class="close-btn" onclick="closeEditProfile()">&times;</button>
    </div>
    <form id="editProfileForm">
      <div class="form-group">
        <label class="form-label">Full Name</label>
        <input type="text" id="editFullName" class="form-control" required>
      </div>
      <div class="form-group" id="qualificationGroup" style="display:none;">
        <label class="form-label">Qualification</label>
        <input type="text" id="editQualification" class="form-control">
      </div>
      <div class="form-group" id="experienceGroup" style="display:none;">
        <label class="form-label">Experience (years)</label>
        <input type="number" id="editExperience" class="form-control">
      </div>
      <div class="form-group" id="institutionGroup" style="display:none;">
        <label class="form-label">Institution</label>
        <input type="text" id="editInstitution" class="form-control">
      </div>
      <div class="form-group">
        <label class="form-label">Age</label>
        <input type="number" id="editAge" class="form-control">
      </div>
      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary flex-grow-1">
          üíæ Save Changes
        </button>
        <button type="button" onclick="closeEditProfile()" class="btn btn-secondary">
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Change Password Modal -->
<div id="changePasswordModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h4>üîí Change Password</h4>
      <button class="close-btn" onclick="closeChangePassword()">&times;</button>
    </div>
    <form id="changePasswordForm">
      <div class="form-group">
        <label class="form-label">Current Password</label>
        <input type="password" id="currentPassword" class="form-control" required>
      </div>
      <div class="form-group">
        <label class="form-label">New Password</label>
        <input type="password" id="newPassword" class="form-control" required minlength="6">
      </div>
      <div class="form-group">
        <label class="form-label">Confirm New Password</label>
        <input type="password" id="confirmNewPassword" class="form-control" required minlength="6">
      </div>
      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary flex-grow-1">
          üîí Change Password
        </button>
        <button type="button" onclick="closeChangePassword()" class="btn btn-secondary">
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<script>
const API_BASE = window.location.origin;
const token = localStorage.getItem("token");
let role = (localStorage.getItem("role") || "").toLowerCase();
let canTeach = false;
let canLearn = false;
let currentUserId = null;
let currentProfileData = null;
let allSkills = []; // Global storage for filtering
const SKILLS_PAGE_SIZE = 9;
let currentSearchViewSkills = [];
let renderedSkillCount = 0;
let currentTrendingSkills = [];
let renderedTrendingCount = 0;
let currentRecentSkills = [];
let renderedRecentCount = 0;
let cachedTrendingSkills = null;
let cachedRecentSkills = null;
let selectedCategoryFilter = "";
let selectedLevelFilter = "";

function normalizeRole(value) {
  return String(value || "").trim().toLowerCase();
}

function computeCapabilities(payload = {}) {
  canTeach = Boolean(payload.can_teach);
  canLearn = Boolean(payload.can_learn);

  const effectiveRole = normalizeRole(payload.role || role);
  if (effectiveRole !== "admin" && !canTeach && !canLearn) {
    // New users may not have added skills yet; default to learner UX.
    canLearn = true;
  }
}

function getManageSkillCtas() {
  const showTeach = canTeach || (!canTeach && !canLearn);
  const showLearn = canLearn || (!canTeach && !canLearn);
  const ctas = [];
  if (showTeach) ctas.push(`<a href="/static/add-skill.html" class="fw-bold">Add Teaching Skill</a>`);
  if (showLearn) ctas.push(`<a href="/static/add-skill.html?type=learn" class="fw-bold">Add Learning Skill</a>`);
  return ctas.join(" or ");
}

if (!token) {
  alert("Please login first!");
  window.location.href = "/static/login.html";
}

// Toggle sliding sidebar
function toggleProfileSidebar() {
  const sidebar = document.getElementById("profileSidebar");
  const overlay = document.getElementById("sidebarOverlay");
  sidebar.classList.toggle("open");
  overlay.classList.toggle("show");
}
function closeProfileSidebar() {
  document.getElementById("profileSidebar").classList.remove("open");
  document.getElementById("sidebarOverlay").classList.remove("show");
}

// Load profile
async function loadProfile() {
  try {
    const response = await fetch(`${API_BASE}/users/me`, {
      headers: { "Authorization": `Bearer ${token}` }
    });
    if (!response.ok) throw new Error("Failed to load profile");
    const payload = await response.json();
    const profile = payload.profile || {};
    currentProfileData = payload;
    currentUserId = payload.id;
    role = normalizeRole(payload.role || role);
    localStorage.setItem("role", role);
    computeCapabilities(payload);

    // Use profile.full_name first, then account name/email.
    const fullName = (profile.full_name || payload.name || "").trim() ||
                    (payload.email ? payload.email.split('@')[0] : "User");
    
    document.getElementById("navName").textContent = fullName;
    document.getElementById("profileName").textContent = fullName;

    const qualificationValue = profile.qualification || payload.qualification || "Not specified";
    const experienceValue = profile.experience || payload.experience || "Not specified";
    document.getElementById("mentorEmail").textContent = payload.email || "-";
    document.getElementById("mentorQualification").textContent = qualificationValue;
    document.getElementById("mentorExperience").textContent = experienceValue;
    document.getElementById("mentorAge").textContent = profile.age || "Not specified";
    document.getElementById("learnerFullName").textContent = fullName;
    document.getElementById("learnerEmail").textContent = payload.email || "-";
    document.getElementById("learnerInstitution").textContent = profile.college || "Not specified";
    document.getElementById("learnerAge").textContent = profile.age || "Not specified";

    const mentorProfileEl = document.getElementById("mentorProfile");
    const learnerProfileEl = document.getElementById("learnerProfile");
    const mentorRatingsBtn = document.getElementById("mentorRatingsBtn");
    if (mentorRatingsBtn) {
      mentorRatingsBtn.style.display = canTeach ? "block" : "none";
    }

    if (role === "admin") {
      document.getElementById("navAvatar").textContent = "üõ°Ô∏è";
      document.getElementById("profileAvatar").textContent = "üõ°Ô∏è";
      document.getElementById("profileRole").textContent = "Admin";
      mentorProfileEl.style.display = "none";
      learnerProfileEl.style.display = "none";
      return;
    }

    const isDualRole = canTeach && canLearn;
    if (isDualRole) {
      document.getElementById("navAvatar").textContent = "üßë‚Äçüéì";
      document.getElementById("profileAvatar").textContent = "üßë‚Äçüéì";
      document.getElementById("profileRole").textContent = "Mentor + Learner";
      // Dual-role users see one consolidated sidebar section to avoid duplication.
      mentorProfileEl.style.display = "block";
      learnerProfileEl.style.display = "none";
    } else if (canTeach) {
      document.getElementById("navAvatar").textContent = "üë®‚Äçüè´";
      document.getElementById("profileAvatar").textContent = "üë®‚Äçüè´";
      document.getElementById("profileRole").textContent = "Mentor";
      mentorProfileEl.style.display = "block";
      learnerProfileEl.style.display = "none";
    } else {
      document.getElementById("navAvatar").textContent = "üë§";
      document.getElementById("profileAvatar").textContent = "üë§";
      document.getElementById("profileRole").textContent = "Learner";
      learnerProfileEl.style.display = "block";
      mentorProfileEl.style.display = "none";
    }

  } catch (error) {
    console.error("Error loading profile:", error);
    // Keep default values but log error
    document.getElementById("navName").textContent = "User";
    document.getElementById("profileName").textContent = "User";
  }
}

function updateActiveCategoryChip() {
  const chip = document.getElementById("activeCategoryChip");
  if (!chip) return;
  if (!selectedCategoryFilter) {
    chip.style.display = "none";
    chip.textContent = "";
    return;
  }
  chip.style.display = "inline-flex";
  chip.textContent = `Category: ${selectedCategoryFilter}`;
}

// Load skills from backend with current search/category/level filters.
async function loadSkills() {
  try {
    const query = document.getElementById("searchInput").value.trim();
    const params = new URLSearchParams();
    if (query) params.set("query", query);
    if (selectedCategoryFilter) params.set("category", selectedCategoryFilter);
    if (selectedLevelFilter) params.set("level", selectedLevelFilter);
    params.set("sort_by", "popularity");

    const res = await fetch(`${API_BASE}/search/skills?${params.toString()}`, {
      headers: { "Authorization": `Bearer ${token}` }
    });

    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const skills = await res.json();

    allSkills = skills;
    displaySkills(skills);
    updateActiveCategoryChip();
  } catch (err) {
    console.error("Failed to load skills:", err);
    document.getElementById("skillsContainer").innerHTML =
      `<div class="alert alert-warning text-center py-4">
        <i class="fas fa-exclamation-triangle me-2"></i>
        No skills available. Add some via ${getManageSkillCtas()}.
      </div>`;
    document.getElementById("loadMoreContainer").style.display = "none";
  }
}

// Display skills
function displaySkills(skills) {
  const container = document.getElementById("skillsContainer");
  const loadMoreContainer = document.getElementById("loadMoreContainer");
  const loadMoreBtn = document.getElementById("loadMoreBtn");
  currentSearchViewSkills = skills || [];
  renderedSkillCount = 0;
  
  if (currentSearchViewSkills.length === 0) {
    container.innerHTML = '<p class="text-center py-5">No skills found</p>';
    loadMoreContainer.style.display = "none";
    return;
  }

  const initialChunk = currentSearchViewSkills.slice(0, SKILLS_PAGE_SIZE);
  renderedSkillCount = initialChunk.length;
  container.innerHTML = initialChunk.map(renderSkillCard).join('');

  if (renderedSkillCount < currentSearchViewSkills.length) {
    loadMoreContainer.style.display = "block";
    loadMoreBtn.textContent = `Load More (${currentSearchViewSkills.length - renderedSkillCount} remaining)`;
  } else {
    loadMoreContainer.style.display = "none";
  }
}

function loadMoreSkills() {
  const container = document.getElementById("skillsContainer");
  const loadMoreContainer = document.getElementById("loadMoreContainer");
  const loadMoreBtn = document.getElementById("loadMoreBtn");

  const nextChunk = currentSearchViewSkills.slice(
    renderedSkillCount,
    renderedSkillCount + SKILLS_PAGE_SIZE
  );

  if (nextChunk.length === 0) {
    loadMoreContainer.style.display = "none";
    return;
  }

  container.insertAdjacentHTML("beforeend", nextChunk.map(renderSkillCard).join(""));
  renderedSkillCount += nextChunk.length;

  if (renderedSkillCount < currentSearchViewSkills.length) {
    loadMoreBtn.textContent = `Load More (${currentSearchViewSkills.length - renderedSkillCount} remaining)`;
  } else {
    loadMoreContainer.style.display = "none";
  }
}

// Navigate to mentors page
function viewMentors(skillId, skillName) {
  const params = new URLSearchParams();
  params.set("skill", String(skillId));
  params.set("name", skillName);
  if (selectedLevelFilter) {
    params.set("level", selectedLevelFilter);
  }
  window.location.href = `/static/mentors.html?${params.toString()}`;
}

// Search functionality
async function performSearch() {
  await loadSkills();
}

function handleSearchEnter(e) { 
  if (e.key === "Enter") performSearch(); 
}

function quickSearch(q) { 
  document.getElementById("searchInput").value = q; 
  performSearch(); 
}

function filterByCategory(cat) {
  selectedCategoryFilter = cat;
  performSearch();
}

function onLevelFilterChange() {
  const levelValue = document.getElementById("levelFilter").value || "";
  selectedLevelFilter = levelValue;
  performSearch();
}

function clearSearchFilters() {
  selectedCategoryFilter = "";
  selectedLevelFilter = "";
  document.getElementById("searchInput").value = "";
  const levelFilter = document.getElementById("levelFilter");
  if (levelFilter) levelFilter.value = "";
  performSearch();
}

function toggleShortcutsPanel() {
  const panel = document.getElementById("shortcutsPanel");
  panel.classList.toggle("open");
}

async function showTab(tab, evt = null) {
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  if (evt && evt.target) {
    evt.target.classList.add('active');
  } else {
    const tabMap = {
      search: 0,
      trending: 1,
      recent: 2
    };
    const idx = tabMap[tab] ?? 0;
    const btn = document.querySelectorAll('.tab-btn')[idx];
    if (btn) btn.classList.add('active');
  }
  ['searchTab', 'trendingTab', 'recentTab'].forEach(id => {
    document.getElementById(id).style.display = 'none';
  });
  document.getElementById(`${tab}Tab`).style.display = 'block';
  
  // Load tab-specific data
  if (tab === 'trending') {
    await renderTrendingTab();
  } else if (tab === 'recent') {
    await renderRecentTab();
  }
}

async function fetchTrendingSkills(forceRefresh = false) {
  if (cachedTrendingSkills && !forceRefresh) return cachedTrendingSkills;

  const res = await fetch(`${API_BASE}/search/skills/trending?days=30&limit=200`, {
    headers: { "Authorization": `Bearer ${token}` }
  });
  if (!res.ok) throw new Error(`Failed to load trending skills: HTTP ${res.status}`);
  cachedTrendingSkills = await res.json();
  return cachedTrendingSkills;
}

async function fetchRecentSkills(forceRefresh = false) {
  if (cachedRecentSkills && !forceRefresh) return cachedRecentSkills;

  const res = await fetch(`${API_BASE}/search/skills/recent?limit=200`, {
    headers: { "Authorization": `Bearer ${token}` }
  });
  if (!res.ok) throw new Error(`Failed to load recent skills: HTTP ${res.status}`);
  cachedRecentSkills = await res.json();
  return cachedRecentSkills;
}

async function renderTrendingTab() {
  const container = document.getElementById("trendingContainer");
  const loadMoreContainer = document.getElementById("trendingLoadMoreContainer");
  const loadMoreBtn = document.getElementById("trendingLoadMoreBtn");

  try {
    currentTrendingSkills = await fetchTrendingSkills(false);
  } catch (error) {
    console.error("Trending fetch failed:", error);
    container.innerHTML = `
      <div class="alert alert-warning text-center py-4">
        <i class="fas fa-exclamation-triangle me-2"></i>
        Backend trending analytics unavailable right now.
        <div class="mt-3">
          <button class="btn btn-outline-primary" onclick="renderTrendingTab()">Retry</button>
        </div>
      </div>
    `;
    loadMoreContainer.style.display = "none";
    return;
  }
  renderedTrendingCount = 0;

  if (currentTrendingSkills.length === 0) {
    container.innerHTML = '<p class="text-center py-5">No trending skills found</p>';
    loadMoreContainer.style.display = "none";
    return;
  }

  const initialChunk = currentTrendingSkills.slice(0, SKILLS_PAGE_SIZE);
  renderedTrendingCount = initialChunk.length;
  container.innerHTML = initialChunk.map(renderSkillCard).join("");

  if (renderedTrendingCount < currentTrendingSkills.length) {
    loadMoreContainer.style.display = "block";
    loadMoreBtn.textContent = `Load More (${currentTrendingSkills.length - renderedTrendingCount} remaining)`;
  } else {
    loadMoreContainer.style.display = "none";
  }
}

function loadMoreTrendingSkills() {
  const container = document.getElementById("trendingContainer");
  const loadMoreContainer = document.getElementById("trendingLoadMoreContainer");
  const loadMoreBtn = document.getElementById("trendingLoadMoreBtn");

  const nextChunk = currentTrendingSkills.slice(
    renderedTrendingCount,
    renderedTrendingCount + SKILLS_PAGE_SIZE
  );

  if (nextChunk.length === 0) {
    loadMoreContainer.style.display = "none";
    return;
  }

  container.insertAdjacentHTML("beforeend", nextChunk.map(renderSkillCard).join(""));
  renderedTrendingCount += nextChunk.length;

  if (renderedTrendingCount < currentTrendingSkills.length) {
    loadMoreBtn.textContent = `Load More (${currentTrendingSkills.length - renderedTrendingCount} remaining)`;
  } else {
    loadMoreContainer.style.display = "none";
  }
}

async function renderRecentTab() {
  const container = document.getElementById("recentContainer");
  const loadMoreContainer = document.getElementById("recentLoadMoreContainer");
  const loadMoreBtn = document.getElementById("recentLoadMoreBtn");

  try {
    currentRecentSkills = await fetchRecentSkills(false);
  } catch (error) {
    console.error("Recent fetch failed:", error);
    container.innerHTML = `
      <div class="alert alert-warning text-center py-4">
        <i class="fas fa-exclamation-triangle me-2"></i>
        Backend recent-skills feed unavailable right now.
        <div class="mt-3">
          <button class="btn btn-outline-primary" onclick="renderRecentTab()">Retry</button>
        </div>
      </div>
    `;
    loadMoreContainer.style.display = "none";
    return;
  }
  renderedRecentCount = 0;

  if (currentRecentSkills.length === 0) {
    container.innerHTML = '<p class="text-center py-5">No recent skills found</p>';
    loadMoreContainer.style.display = "none";
    return;
  }

  const initialChunk = currentRecentSkills.slice(0, SKILLS_PAGE_SIZE);
  renderedRecentCount = initialChunk.length;
  container.innerHTML = initialChunk.map(renderSkillCard).join("");

  if (renderedRecentCount < currentRecentSkills.length) {
    loadMoreContainer.style.display = "block";
    loadMoreBtn.textContent = `Load More (${currentRecentSkills.length - renderedRecentCount} remaining)`;
  } else {
    loadMoreContainer.style.display = "none";
  }
}

function loadMoreRecentSkills() {
  const container = document.getElementById("recentContainer");
  const loadMoreContainer = document.getElementById("recentLoadMoreContainer");
  const loadMoreBtn = document.getElementById("recentLoadMoreBtn");

  const nextChunk = currentRecentSkills.slice(
    renderedRecentCount,
    renderedRecentCount + SKILLS_PAGE_SIZE
  );

  if (nextChunk.length === 0) {
    loadMoreContainer.style.display = "none";
    return;
  }

  container.insertAdjacentHTML("beforeend", nextChunk.map(renderSkillCard).join(""));
  renderedRecentCount += nextChunk.length;

  if (renderedRecentCount < currentRecentSkills.length) {
    loadMoreBtn.textContent = `Load More (${currentRecentSkills.length - renderedRecentCount} remaining)`;
  } else {
    loadMoreContainer.style.display = "none";
  }
}

function renderSkillCard(skill) {
  const levelBadge = selectedLevelFilter
    ? `<span class="badge text-bg-light border">Level: ${selectedLevelFilter}</span>`
    : "";
  return `
    <div class="skill-card">
      <div class="d-flex justify-content-between align-items-start mb-3">
        <h5 class="skill-title">${skill.name}</h5>
        <span class="mentor-count">${skill.mentor_count} üë®‚Äçüè´</span>
      </div>
      ${levelBadge}
      <p class="text-muted">${skill.description || ''}</p>
      <button class="view-mentors-btn" 
              onclick="viewMentors(${skill.id}, '${skill.name.replace(/'/g, "\\'")}');">
        View Mentors ‚Üí
      </button>
    </div>
  `;
}

// Profile modals
function showEditProfile() {
  const profile = (currentProfileData && currentProfileData.profile) || {};
  const fallbackName = document.getElementById("profileName").textContent || "";
  document.getElementById("editFullName").value = profile.full_name || fallbackName;
  document.getElementById("editAge").value = profile.age || "";

  const showMentorFields = canTeach;
  const showLearnerFields = canLearn;
  document.getElementById("qualificationGroup").style.display = showMentorFields ? "block" : "none";
  document.getElementById("experienceGroup").style.display = showMentorFields ? "block" : "none";
  document.getElementById("institutionGroup").style.display = showLearnerFields ? "block" : "none";

  if (showMentorFields) {
    document.getElementById("editQualification").value = profile.qualification || "";
    document.getElementById("editExperience").value = profile.experience || "";
  }
  if (showLearnerFields) {
    document.getElementById("editInstitution").value = profile.college || "";
  }
  document.getElementById("editProfileModal").classList.add("show");
}
function closeEditProfile() {
  document.getElementById("editProfileModal").classList.remove("show");
}

document.getElementById("editProfileForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  try {
    const formData = new FormData();
    const fullName = document.getElementById("editFullName").value.trim();
    const age = document.getElementById("editAge").value.trim();

    if (fullName) formData.append("full_name", fullName);
    if (age) formData.append("age", age);

    if (canTeach) {
      const qualification = document.getElementById("editQualification").value.trim();
      const experience = document.getElementById("editExperience").value.trim();
      if (qualification) formData.append("qualification", qualification);
      if (experience) formData.append("experience", experience);
    }
    if (canLearn) {
      const institution = document.getElementById("editInstitution").value.trim();
      if (institution) formData.append("studying", institution);
    }

    const response = await fetch(`${API_BASE}/users/profile`, {
      method: "PUT",
      headers: { "Authorization": `Bearer ${token}` },
      body: formData
    });

    if (!response.ok) {
      const err = await response.json().catch(() => ({}));
      throw new Error(err.detail || "Failed to update profile");
    }

    alert("Profile updated successfully");
    closeEditProfile();
    await loadProfile();
  } catch (error) {
    alert(`Profile update failed: ${error.message}`);
  }
});

function showChangePassword() {
  document.getElementById("changePasswordModal").classList.add("show");
}
function closeChangePassword() {
  document.getElementById("changePasswordModal").classList.remove("show");
}
document.getElementById("changePasswordForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  try {
    const currentPassword = document.getElementById("currentPassword").value;
    const newPassword = document.getElementById("newPassword").value;
    const confirmNewPassword = document.getElementById("confirmNewPassword").value;

    if (newPassword !== confirmNewPassword) {
      alert("New password and confirm password do not match.");
      return;
    }

    const formData = new FormData();
    formData.append("current_password", currentPassword);
    formData.append("new_password", newPassword);

    const response = await fetch(`${API_BASE}/users/password`, {
      method: "PUT",
      headers: { "Authorization": `Bearer ${token}` },
      body: formData
    });

    if (!response.ok) {
      const err = await response.json().catch(() => ({}));
      throw new Error(err.detail || "Failed to change password");
    }

    alert("Password changed successfully");
    closeChangePassword();
    document.getElementById("changePasswordForm").reset();
  } catch (error) {
    alert(`Password change failed: ${error.message}`);
  }
});

function openMyMentorProfile() {
  if (!currentUserId) {
    alert("Profile is still loading. Please try again.");
    return;
  }
  closeProfileSidebar();
  window.location.href = `/static/mentor-profile.html?mentor_id=${currentUserId}`;
}

function logout() {
  localStorage.clear();
  window.location.href = "/static/login.html";
}

// Notification bell counter
async function loadNotifCount() {
  const t = localStorage.getItem("token");
  if (!t) return;
  try {
    const res = await fetch(`${window.location.origin}/notifications/unread-count`, {
      headers: { "Authorization": `Bearer ${t}` }
    });
    if (!res.ok) return;
    const data = await res.json();
    const badge = document.getElementById("notifCount");
    if (badge && data.unread_count > 0) {
      badge.textContent = data.unread_count;
      badge.style.display = "flex";
    }
  } catch (e) {}
}
loadNotifCount();

// Initialize
window.onload = async () => {
  await loadProfile();
  await loadSkills();
};
</script>
</body>
</html>
