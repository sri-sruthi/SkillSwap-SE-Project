    <!DOCTYPE html>
    <html lang="en">
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - SkillSwap Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body { background: linear-gradient(135deg,#0f172a,#1e293b); min-height:100vh;
            font-family:'Segoe UI',sans-serif; color:#e2e8f0; padding:24px; }
        .topbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:28px; }
        .topbar h1 { font-size:1.8rem; font-weight:800; color:#f1f5f9; margin:0; }
        .card { background:rgba(255,255,255,0.07); border:1px solid rgba(255,255,255,0.12);
            border-radius:14px; padding:22px; margin-bottom:20px; }
        .stat-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
                    gap:14px; margin-bottom:24px; }
        .stat-box { background:rgba(255,255,255,0.07); border-radius:12px; padding:18px; text-align:center; }
        .stat-num { font-size:1.9rem; font-weight:800; color:#818cf8; }
        .stat-label { font-size:0.78rem; color:#94a3b8; margin-top:4px; }
        .section-title { font-size:1.05rem; font-weight:700; color:#f1f5f9; margin-bottom:14px; }
        .charts-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
        .export-btn { background:linear-gradient(135deg,#818cf8,#6366f1); border:none; color:white;
                    padding:8px 18px; border-radius:8px; font-size:0.88rem; cursor:pointer; margin-right:8px; }
        .back-link { color:#818cf8; text-decoration:none; font-size:0.9rem; }
        @media(max-width:640px) { .charts-grid { grid-template-columns:1fr; } }
    </style>
    </head>
<body>

    <div class="topbar">
    <div>
        <a href="/admin/dashboard" class="back-link">‚Üê Admin Dashboard</a>
        <h1 style="margin-top:6px;">üìä Analytics</h1>
    </div>
    <div>
        <button class="export-btn" onclick="exportCSV('sessions')">‚¨á Sessions CSV</button>
        <button class="export-btn" onclick="exportCSV('users')">‚¨á Users CSV</button>
        <button class="export-btn" onclick="exportCSV('tokens')">‚¨á Tokens CSV</button>
    </div>
    </div>

    <!-- Overview Stats -->
    <div class="stat-grid">
    <div class="stat-box"><div class="stat-num" id="o-users">‚Äì</div><div class="stat-label">Total Users</div></div>
    <div class="stat-box"><div class="stat-num" id="o-sessions">‚Äì</div><div class="stat-label">Total Sessions</div></div>
    <div class="stat-box"><div class="stat-num" id="o-completed">‚Äì</div><div class="stat-label">Completed</div></div>
    <div class="stat-box"><div class="stat-num" id="o-rate">‚Äì</div><div class="stat-label">Completion %</div></div>
    <div class="stat-box"><div class="stat-num" id="o-reviews">‚Äì</div><div class="stat-label">Reviews</div></div>
    <div class="stat-box"><div class="stat-num" id="o-rating">‚Äì</div><div class="stat-label">Avg Rating</div></div>
    <div class="stat-box"><div class="stat-num" id="o-tokens">‚Äì</div><div class="stat-label">Tokens Circulating</div></div>
    </div>

    <div class="charts-grid">
    <!-- Session Status Pie -->
    <div class="card">
        <div class="section-title">Session Status Distribution</div>
        <canvas id="sessionStatusChart" height="220"></canvas>
    </div>

    <!-- Rating Distribution Bar -->
    <div class="card">
        <div class="section-title">Rating Distribution</div>
        <canvas id="ratingChart" height="220"></canvas>
    </div>

    <!-- Daily Sessions Line -->
    <div class="card">
        <div class="section-title">Sessions (Last 14 Days)</div>
        <canvas id="dailyChart" height="220"></canvas>
    </div>

    <!-- Token Distribution -->
    <div class="card">
        <div class="section-title">Token Wallet Distribution</div>
        <canvas id="tokenDistChart" height="220"></canvas>
    </div>
    </div>

    <!-- Top Skills -->
    <div class="card">
    <div class="section-title">Most Requested Skills</div>
    <div id="skillsTable" style="color:#94a3b8;">Loading‚Ä¶</div>
    </div>

<!-- Top Mentors -->
    <div class="card">
    <div class="section-title">Top Rated Mentors</div>
    <div id="mentorsTable" style="color:#94a3b8;">Loading‚Ä¶</div>
    </div>

    <script>
    const API = window.location.origin;
    const tok = localStorage.getItem("token");
    if (!tok || (localStorage.getItem("role") || "").toLowerCase() !== "admin") {
    window.location.href = "/admin/login";
}

const CHART_COLORS = ['#818cf8','#34d399','#fb923c','#f472b6','#60a5fa','#a78bfa'];

    async function apiFetch(path) {
    const r = await fetch(`${API}${path}`, { headers:{ "Authorization":`Bearer ${tok}` } });
    return r.ok ? r.json() : null;
    }

    async function loadOverview() {
    const d = await apiFetch("/analytics/overview");
    if (!d) return;
    document.getElementById("o-users").textContent    = d.total_users;
    document.getElementById("o-sessions").textContent = d.total_sessions;
    document.getElementById("o-completed").textContent= d.completed_sessions;
    document.getElementById("o-rate").textContent     = d.completion_rate_pct + "%";
    document.getElementById("o-reviews").textContent  = d.total_reviews;
    document.getElementById("o-rating").textContent   = d.average_rating + "‚≠ê";
    document.getElementById("o-tokens").textContent   = d.tokens_in_circulation;
}

    async function loadSessionCharts() {
    const d = await apiFetch("/analytics/sessions");
    if (!d) return;

    // Pie chart
    const statuses = Object.keys(d.by_status);
    const counts   = Object.values(d.by_status);
    new Chart(document.getElementById("sessionStatusChart"), {
        type: "doughnut",
        data: { labels: statuses, datasets:[{ data: counts, backgroundColor: CHART_COLORS }] },
        options: { plugins:{ legend:{ labels:{ color:"#e2e8f0" } } } }
    });

    // Line chart
    const days   = d.daily_last_14_days.map(r => r.date.slice(5));
    const dcounts= d.daily_last_14_days.map(r => r.count);
    new Chart(document.getElementById("dailyChart"), {
        type: "line",
        data: {
        labels: days,
        datasets:[{ label:"Sessions", data: dcounts,
            borderColor:"#818cf8", backgroundColor:"rgba(129,140,248,0.15)",
            fill:true, tension:0.4, pointRadius:4 }]
            },
        options: {
        plugins:{ legend:{ labels:{ color:"#e2e8f0" } } },
        scales:{
            x:{ ticks:{ color:"#94a3b8" }, grid:{ color:"rgba(255,255,255,0.06)" } },
            y:{ ticks:{ color:"#94a3b8", stepSize:1 }, grid:{ color:"rgba(255,255,255,0.06)" } }
        }
        }
    });
    }

    async function loadRatings() {
    const d = await apiFetch("/analytics/ratings");
    if (!d) return;

    const labels = ["1‚òÖ","2‚òÖ","3‚òÖ","4‚òÖ","5‚òÖ"];
    const vals   = labels.map((_,i) => d.rating_distribution[String(i+1)] || 0);
    new Chart(document.getElementById("ratingChart"), {
        type: "bar",
        data: {
        labels,
        datasets:[{ label:"Reviews", data: vals,
            backgroundColor:["#ef4444","#fb923c","#fbbf24","#34d399","#818cf8"] }]
        },
        options: {
        plugins:{ legend:{ display:false } },
        scales:{
            x:{ ticks:{ color:"#94a3b8" }, grid:{ color:"rgba(255,255,255,0.06)" } },
            y:{ ticks:{ color:"#94a3b8", stepSize:1 }, grid:{ color:"rgba(255,255,255,0.06)" } }
        }
        }
    });

    const top = d.top_mentors;
    if (top.length === 0) {
        document.getElementById("mentorsTable").textContent = "No reviews yet.";
        return;
    }
    document.getElementById("mentorsTable").innerHTML = `
        <table style="width:100%;border-collapse:collapse;">
        <tr style="color:#64748b;font-size:0.8rem;">
            <th style="padding:6px 0;">Mentor</th>
            <th>Avg Rating</th><th>Reviews</th>
        </tr>
        ${top.map(m => `
            <tr style="border-bottom:1px solid rgba(255,255,255,0.06);">
            <td style="padding:8px 0;">${m.name}</td>
            <td>‚≠ê ${m.avg_rating}</td>
            <td style="color:#94a3b8;">${m.reviews}</td>
            </tr>`).join("")}
        </table>`;
}

async function loadTokens() {
    const d = await apiFetch("/analytics/tokens");
    if (!d) return;
    const dist = d.wallet_distribution;
    new Chart(document.getElementById("tokenDistChart"), {
        type: "bar",
        data: {
        labels: Object.keys(dist),
        datasets:[{ label:"Users", data: Object.values(dist),
            backgroundColor:["#ef4444","#fb923c","#34d399","#818cf8"] }]
        },
        options: {
        plugins:{ legend:{ display:false } },
        scales:{
            x:{ ticks:{ color:"#94a3b8" }, grid:{ color:"rgba(255,255,255,0.06)" } },
            y:{ ticks:{ color:"#94a3b8", stepSize:1 }, grid:{ color:"rgba(255,255,255,0.06)" } }
        }
        }
    });
}

async function loadSkills() {
    const d = await apiFetch("/analytics/skills/popular");
    if (!d) return;
    const rows = d.most_requested;
    if (!rows.length) { document.getElementById("skillsTable").textContent = "No session data yet."; return; }
    document.getElementById("skillsTable").innerHTML = `
    <table style="width:100%;border-collapse:collapse;">
        <tr style="color:#64748b;font-size:0.8rem;"><th style="padding:6px 0;">Skill</th><th>Sessions</th></tr>
        ${rows.map(r => `
        <tr style="border-bottom:1px solid rgba(255,255,255,0.06);">
            <td style="padding:8px 0;">${r.skill}</td>
            <td>${r.sessions}</td>
        </tr>`).join("")}
    </table>`;
}

async function exportCSV(type) {
  try {
    const res = await fetch(`${API}/analytics/export?report_type=${type}`, {
      headers: { "Authorization": `Bearer ${tok}` }
    });

    if (!res.ok) {
      alert("Export failed: " + res.status);
      return;
    }

    // Get the file as a blob and create a download link
    const blob = await res.blob();
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement("a");
    a.href     = url;
    a.download = `skillswap_${type}_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

  } catch (err) {
    console.error("Export error:", err);
    alert("Export failed: " + err.message);
  }
}

// Load everything
loadOverview();
loadSessionCharts();
loadRatings();
loadTokens();
loadSkills();
</script>
</body>
</html>