<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifications - SkillSwap</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        padding: 30px 20px;
        }
        .container { max-width: 700px; margin: 0 auto; }
        .card {
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }
        .page-title {
        font-size: 1.8rem;
        font-weight: 800;
        background: linear-gradient(135deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 5px;
        }
        .notification-item {
        display: flex;
        align-items: flex-start;
        gap: 14px;
        padding: 16px;
        border-radius: 12px;
        margin-bottom: 10px;
        border: 1px solid #e5e7eb;
        transition: all 0.2s;
        cursor: pointer;
        }
        .notification-item:hover { background: #f9fafb; }
        .notification-item.unread {
        background: #f0f4ff;
        border-color: #c7d2fe;
        }
        .notif-icon {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        flex-shrink: 0;
        }
        .icon-session_requested   { background: #dbeafe; color: #2563eb; }
        .icon-session_confirmed   { background: #d1fae5; color: #059669; }
        .icon-session_declined    { background: #fee2e2; color: #dc2626; }
        .icon-session_completed   { background: #fef3c7; color: #d97706; }
        .icon-review_received     { background: #fce7f3; color: #db2777; }
        .icon-session_cancelled   { background: #f3f4f6; color: #6b7280; }
        .icon-default             { background: #f3f4f6; color: #6b7280; }
        .notif-message { font-size: 0.95rem; color: #374151; margin-bottom: 3px; }
        .notif-time { font-size: 0.8rem; color: #9ca3af; }
        .unread-dot {
        width: 8px; height: 8px;
        background: #667eea;
        border-radius: 50%;
        margin-top: 6px;
        flex-shrink: 0;
        }
        .btn-mark-all {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 8px;
        font-size: 0.9rem;
        cursor: pointer;
        }
        .back-link { color: #667eea; text-decoration: none; font-weight: 600; }
        .empty-state { text-align: center; padding: 40px 20px; color: #9ca3af; }
        .empty-state i { font-size: 3rem; margin-bottom: 15px; display: block; }
    </style>
    </head>
    <body>
    <div class="container">
    <div class="card">
        <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <a href="/static/search.html" class="back-link">
            <i class="fas fa-arrow-left me-2"></i>Back
            </a>
            <h1 class="page-title mt-2">Notifications</h1>
            <p id="unreadBadge" class="text-muted mb-0"></p>
        </div>
        <button class="btn-mark-all" onclick="markAllRead()">
            <i class="fas fa-check-double me-1"></i> Mark All Read
        </button>
        </div>

        <div id="notificationsList">
        <div class="empty-state">
            <i class="fas fa-spinner fa-spin"></i>
            Loading...
        </div>
        </div>
    </div>
    </div>

    <script>
    const API_BASE = window.location.origin;
    const token = localStorage.getItem("token");

    if (!token) {
    window.location.href = "/static/login.html";
    }

    const ICONS = {
    session_requested:          { icon: "fa-calendar-plus",   cls: "icon-session_requested" },
    session_confirmed:          { icon: "fa-check-circle",    cls: "icon-session_confirmed" },
    session_declined:           { icon: "fa-times-circle",    cls: "icon-session_declined" },
    session_completed:          { icon: "fa-star",            cls: "icon-session_completed" },
    session_cancelled:          { icon: "fa-ban",             cls: "icon-session_cancelled" },
    session_reschedule_accepted:{ icon: "fa-calendar-check",  cls: "icon-session_confirmed" },
    session_reschedule_declined:{ icon: "fa-calendar-times",  cls: "icon-session_declined" },
    review_received:            { icon: "fa-star-half-alt",   cls: "icon-review_received" },
    };

    function timeAgo(isoString) {
    if (!isoString) return "";
    const diff = Math.floor((Date.now() - new Date(isoString)) / 1000);
    if (diff < 60) return "just now";
    if (diff < 3600) return Math.floor(diff/60) + " min ago";
    if (diff < 86400) return Math.floor(diff/3600) + " hr ago";
    return Math.floor(diff/86400) + " days ago";
    }

    async function loadNotifications() {
    try {
        const res = await fetch(`${API_BASE}/notifications/my`, {
        headers: { "Authorization": `Bearer ${token}` }
        });
        if (!res.ok) throw new Error("Failed to load");
        const notifications = await res.json();

        const unread = notifications.filter(n => !n.is_read).length;
        document.getElementById("unreadBadge").textContent =
        unread > 0 ? `${unread} unread` : "All caught up!";

        const container = document.getElementById("notificationsList");

        if (notifications.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
            <i class="fas fa-bell-slash"></i>
            <p>No notifications yet</p>
            </div>`;
        return;
        }

        container.innerHTML = notifications.map(n => {
        const meta = ICONS[n.event_type] || { icon: "fa-bell", cls: "icon-default" };
        return `
            <div class="notification-item ${n.is_read ? '' : 'unread'}"
                onclick="markRead(${n.id}, this)">
            <div class="notif-icon ${meta.cls}">
                <i class="fas ${meta.icon}"></i>
            </div>
            <div style="flex:1">
                <div class="notif-message">${n.message}</div>
                <div class="notif-time">${timeAgo(n.created_at)}</div>
            </div>
            ${!n.is_read ? '<div class="unread-dot"></div>' : ''}
            </div>`;
        }).join("");
    } catch (err) {
    console.error("Notification fetch error:", err);
    document.getElementById("notificationsList").innerHTML = `
        <div class="empty-state">
            <i class="fas fa-exclamation-circle" style="color:#ef4444;"></i>
            <p style="color:#ef4444;">Error: ${err.message}</p>
            <p style="font-size:0.8rem;">Check browser console for details</p>
        </div>`;
    }
    }

    async function markRead(id, element) {
    await fetch(`${API_BASE}/notifications/${id}/read`, {
        method: "PATCH",
        headers: { "Authorization": `Bearer ${token}` }
    });
    element.classList.remove("unread");
    const dot = element.querySelector(".unread-dot");
    if (dot) dot.remove();
    }

    async function markAllRead() {
    await fetch(`${API_BASE}/notifications/read-all`, {
        method: "PATCH",
        headers: { "Authorization": `Bearer ${token}` }
    });
    loadNotifications();
    }

    loadNotifications();
    </script>
    </body>
    </html>