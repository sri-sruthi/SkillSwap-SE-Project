<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - SkillSwap</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #6b6bd6, #8a6cd9);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .card {
      width: 450px;
      padding: 30px;
      border-radius: 18px;
      box-shadow: 0 20px 40px rgba(0,0,0,.2);
      background: white;
    }
    .logo {
      text-align: center;
      margin-bottom: 25px;
    }
    .logo h2 {
      color: #6b6bd6;
      font-weight: 800;
      font-size: 2.2rem;
    }
    .form-control {
      padding: 12px 15px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 1rem;
    }
    .form-control:focus {
      border-color: #6b6bd6;
      box-shadow: 0 0 0 3px rgba(107, 107, 214, 0.2);
    }
    .btn-login {
      background: linear-gradient(135deg, #6b6bd6, #8a6cd9);
      border: none;
      padding: 12px;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 10px;
      transition: all 0.3s;
    }
    .btn-login:hover {
      background: linear-gradient(135deg, #5a5ac9, #7a5cc8);
      transform: translateY(-2px);
    }
    .register-link {
      text-align: center;
      margin-top: 20px;
      color: #6b6bd6;
      font-weight: 500;
    }
    .register-link a {
      color: #6b6bd6;
      text-decoration: none;
      font-weight: 600;
    }
    .register-link a:hover {
      text-decoration: underline;
    }
    .error-message {
      background: #fee2e2;
      color: #b91c1c;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      display: none;
    }
    .university-note {
      background: #dbeafe;
      color: #1e40af;
      padding: 12px;
      border-radius: 8px;
      font-size: 0.9rem;
      margin-top: 15px;
    }
  </style>
</head>
<body>

<div class="card">
  <div class="logo">
    <h2>ðŸŽ“ SkillSwap</h2>
    <p class="text-center text-muted">Sign in to your account</p>
  </div>

  <div id="errorMessage" class="error-message"></div>

  <form id="loginForm">
    <div class="mb-3">
      <input 
        type="email" 
        id="email" 
        class="form-control" 
        placeholder="University Email" 
        required
      >
    </div>
    
    <div class="mb-3">
      <input 
        type="password" 
        id="password" 
        class="form-control" 
        placeholder="Password" 
        required
        minlength="6"
      >
    </div>

    <button type="submit" class="btn btn-login w-100">Sign In</button>
  </form>

  <div class="university-note">
    <i class="fas fa-graduation-cap me-2"></i>
    Use your university email (.edu) to register and login
  </div>

  <p class="register-link">
    Don't have an account? <a href="/static/register.html">Register here</a>
  </p>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
<script>
const API_BASE = "http://localhost:8000";

document.getElementById("loginForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  const errorMessage = document.getElementById("errorMessage");
  
  // Clear previous errors
  errorMessage.style.display = "none";
  
  // Basic validation
  if (!email || !password) {
    showError("Please fill in all fields");
    return;
  }
  
  if (password.length < 6) {
    showError("Password must be at least 6 characters");
    return;
  }
  
try {
    // 1. Prepare data as a plain object for JSON
    const loginData = {
      email: email,
      password: password
    };
    
    const response = await fetch(`${API_BASE}/auth/login`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json" // Tell FastAPI to expect JSON
      },
      body: JSON.stringify(loginData) // Convert object to JSON string
    });
    
    const data = await response.json().catch(() => ({}));
    
    if (!response.ok) {
      // 2. Correctly extract the error message string
      const msg = typeof data.detail === 'string' ? data.detail : "Invalid email or password";
      throw new Error(msg);
    }
    
    // Save auth data
    localStorage.setItem("token", data.access_token);
    localStorage.setItem("role", data.role);
    
    // Role-based redirect
    if (data.role === "mentor") {
      window.location.href = "/static/search.html";
    } else {
      window.location.href = "/static/search.html";
    }
    
  } catch (error) {
    console.error("Login error:", error);
    // 3. 'error.message' is now a clean string, avoiding [object Object]
    showError(error.message);
  }
});

function showError(message) {
  const errorMessage = document.getElementById("errorMessage");
  errorMessage.textContent = message;
  errorMessage.style.display = "block";
}

// Handle Enter key press
document.getElementById("password").addEventListener("keypress", (e) => {
  if (e.key === "Enter") {
    document.getElementById("loginForm").dispatchEvent(new Event("submit"));
  }
});
</script>
</body>
</html>