<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Add Skill</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body{
    background:#f5f7fb;
    min-height:100vh;
    display:flex;
    justify-content:center;
    align-items:center;
}

.card{
    width:450px;
    padding:30px;
    border-radius:16px;
    box-shadow:0 12px 30px rgba(0,0,0,.12);
}

h2{
    text-align:center;
    margin-bottom:15px;
    font-weight:700;
}

.role-badge{
    display:block;
    text-align:center;
    background:#2563eb;
    color:white;
    padding:6px;
    border-radius:8px;
    margin-bottom:20px;
    font-size:14px;
}

button{
    background:#2563eb;
    border:none;
}

#mySkills div{
    background:#f1f3f8;
    padding:8px 12px;
    border-radius:8px;
    margin-top:6px;
}
</style>
</head>

<body>

<div class="card">

<h2>Add Skill</h2>

<span id="roleBadge" class="role-badge"></span>

<form id="skillForm">

<input id="skillName" class="form-control mb-2" placeholder="Skill name" required>

<textarea id="description" class="form-control mb-2" placeholder="Description"></textarea>

<select id="category" class="form-control mb-2">
<option value="Programming">Programming</option>
<option value="Design">Design</option>
<option value="Business">Business</option>
<option value="Other">Other</option>
</select>

<select id="level" class="form-control mb-3">
<option value="beginner">Beginner</option>
<option value="intermediate">Intermediate</option>
<option value="advanced">Advanced</option>
</select>

<button class="btn btn-primary w-100" type="submit">Save Skill</button>

</form>

<hr>

<h5 class="mt-3">My Skills</h5>
<div id="mySkills">Loading...</div>

</div>

<script>
const token = localStorage.getItem("token")
const role = localStorage.getItem("role")

if(!token || !role){
    alert("Please login again")
    window.location.href = "/login"
}

document.getElementById("roleBadge").innerText = "Role: " + role


// ================= SAVE SKILL =================

document.getElementById("skillForm").addEventListener("submit", async (e) => {
    e.preventDefault()

    const skillName = document.getElementById("skillName").value.trim()
    const description = document.getElementById("description").value
    const category = document.getElementById("category").value
    const level = document.getElementById("level").value

    if(!skillName){
        alert("Enter skill name")
        return
    }

    try {

        // ---- CREATE SKILL ----
        const skillRes = await fetch("http://localhost:8000/skills/", {
            method: "POST",
            headers: {
                "Authorization": "Bearer " + token,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                name: skillName,
                description,
                category
            })
        })

        if(!skillRes.ok){
            const err = await skillRes.text()
            alert("Skill create failed: " + err)
            return
        }

        const skill = await skillRes.json()

        // ---- LINK SKILL ----
        const endpoint = role === "mentor"
            ? "http://localhost:8000/skills/teach"
            : "http://localhost:8000/skills/learn"

        const linkRes = await fetch(endpoint, {
            method: "POST",
            headers: {
                "Authorization": "Bearer " + token,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                skill_id: skill.id,
                proficiency_level: level,
                tags: []
            })
        })

        if(!linkRes.ok){
            const err = await linkRes.text()
            alert("Link failed: " + err)
            return
        }

        alert("✅ Skill added successfully!")

        document.getElementById("skillForm").reset()
        loadMySkills()

    } catch (err){
        alert("Unexpected error: " + err)
    }
})


// ================= LOAD MY SKILLS =================

async function loadMySkills(){

    const endpoint = role === "mentor"
        ? "http://localhost:8000/skills/my/teach"
        : "http://localhost:8000/skills/my/learn"

    try{
        const res = await fetch(endpoint, {
            headers: { "Authorization": "Bearer " + token }
        })

        if(!res.ok){
            document.getElementById("mySkills").innerText = "Failed to load skills"
            return
        }

        const skills = await res.json()

        if(skills.length === 0){
            document.getElementById("mySkills").innerText = "No skills added yet"
            return
        }

        let html = ""
        skills.forEach(s => {
            html += `
            <div>
                <strong>${s.skill.name}</strong> — ${s.proficiency_level}
            </div>`
        })

        document.getElementById("mySkills").innerHTML = html

    }catch(err){
        document.getElementById("mySkills").innerText = "Error loading skills"
    }
}

loadMySkills()
</script>

</body>
</html>
