<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Skills - SkillSwap</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea, #764ba2);
            min-height: 100vh;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        /* Top Navigation */
        .top-nav {
            background: white;
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .nav-brand {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .nav-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        /* Notification Bell */
        .notification-bell {
            position: relative;
            cursor: pointer;
            background: #f3f4f6;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .notification-bell:hover {
            background: #e5e7eb;
            transform: scale(1.1);
        }
        
        .bell-icon {
            font-size: 1.4rem;
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            padding: 3px 7px;
            border-radius: 50%;
            min-width: 22px;
            text-align: center;
        }
        
        .notification-badge.hidden {
            display: none;
        }
        
        /* Main Container */
        .container-main {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .page-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .page-header h1 {
            color: white;
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .page-header p {
            color: rgba(255,255,255,0.95);
            font-size: 1.1rem;
        }
        
        /* Cards */
        .card-custom {
            background: white;
            border-radius: 20px;
            padding: 35px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 1.4rem;
            font-weight: 800;
            color: #1f2937;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mode-switch {
            display: inline-flex;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.35);
            border-radius: 999px;
            padding: 4px;
            gap: 4px;
            margin-top: 12px;
        }

        .mode-btn {
            border: none;
            border-radius: 999px;
            padding: 8px 14px;
            font-weight: 700;
            background: transparent;
            color: rgba(255, 255, 255, 0.95);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mode-btn.active {
            background: white;
            color: #1f2937;
        }
        
        /* Form */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            font-weight: 700;
            color: #374151;
            margin-bottom: 8px;
            display: block;
        }
        
        .required {
            color: #ef4444;
        }
        
        .form-control, .form-select {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .form-control:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }
        
        /* Buttons */
        .btn-primary-custom {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary-custom:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary-custom:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Skills List */
        .skills-grid {
            display: grid;
            gap: 20px;
        }
        
        .skill-item {
            background: #f9fafb;
            border-left: 5px solid #667eea;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: start;
            transition: all 0.3s;
        }
        
        .skill-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
        }
        
        .skill-info h5 {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .skill-meta {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }
        
        .skill-badge {
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .badge-category {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .badge-level {
            background: #fce7f3;
            color: #9f1239;
        }
        
        .skill-description {
            color: #6b7280;
            font-size: 0.95rem;
            margin-top: 8px;
        }
        
        .skill-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-delete {
            background: #ef4444;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-delete:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }
        
        .empty-icon {
            font-size: 5rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 4px solid #f3f4f6;
            border-top-color: #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Alert */
        .alert {
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: none;
            animation: slideDown 0.3s;
        }
        
        .alert.show {
            display: block;
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }
        
        .alert-danger {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>

<!-- Top Navigation -->
<div class="top-nav">
    <div class="nav-brand">üéì SkillSwap</div>
    <div class="nav-actions">
        <!-- Notification Bell -->
        <div class="notification-bell" onclick="checkNotifications()" title="Session Requests">
            <span class="bell-icon">üîî</span>
            <span class="notification-badge hidden" id="notificationBadge">0</span>
        </div>
        <button onclick="window.location.href='/static/search.html'" class="btn btn-outline-primary">
            üè† Home
        </button>
        
        <button onclick="window.location.href='/static/search.html'" class="btn btn-outline-primary">
            üîç Browse Skills
        </button>
        <button onclick="window.location.href='/static/recommendations.html'" class="btn btn-primary">
            ü§ñ AI Recommendations
        </button>
        <button onclick="window.location.href='/static/sessions.html'" class="btn btn-outline-info">
            üìÖ Sessions
        </button>
        <button onclick="logout()" class="btn btn-outline-danger">
            üö™ Logout
        </button>
    </div>
</div>

<div class="container-main">
    <!-- Page Header -->
    <div class="page-header">
        <h1>üìö Manage Your Skills</h1>
        <p id="pageSubtitle">Add skills you want to teach and manage your expertise</p>
        <div class="mode-switch" role="tablist" aria-label="Skill mode selector">
            <button type="button" class="mode-btn active" id="teachModeBtn" onclick="switchSkillMode('teach')">I Teach</button>
            <button type="button" class="mode-btn" id="learnModeBtn" onclick="switchSkillMode('learn')">I Learn</button>
        </div>
    </div>

    <!-- Add New Skill Card -->
    <div class="card-custom">
        <h3 class="section-title" id="addSectionTitle">‚ûï Add New Skill</h3>
        
        <div id="alertBox" class="alert"></div>
        
        <form id="addSkillForm">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">Skill Name <span class="required">*</span></label>
                        <input type="text" 
                               id="skillName" 
                               class="form-control" 
                               placeholder="e.g., Python Programming"
                               required>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">Category <span class="required">*</span></label>
                        <select id="category" class="form-select" required>
                            <option value="">-- Select Category --</option>
                            <option value="Programming">üíª Programming</option>
                            <option value="Design">üé® Design</option>
                            <option value="Data Science">üìä Data Science</option>
                            <option value="Business">üíº Business</option>
                            <option value="Marketing">üì¢ Marketing</option>
                            <option value="Music">üéµ Music</option>
                            <option value="Language">üó£Ô∏è Language</option>
                            <option value="Other">üåü Other</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label" id="descriptionLabel">Description <span class="required">*</span></label>
                <textarea id="description" 
                          class="form-control" 
                          rows="3" 
                          placeholder="Describe what you'll teach..."
                          required></textarea>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label" id="proficiencyLabel">Your Proficiency Level <span class="required">*</span></label>
                        <select id="proficiencyLevel" class="form-select" required>
                            <option value="">-- Select Level --</option>
                            <option value="Beginner">üå± Beginner</option>
                            <option value="Intermediate">üìö Intermediate</option>
                            <option value="Advanced">üöÄ Advanced</option>
                            <option value="Expert">‚≠ê Expert</option>
                        </select>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="form-label">Tags (Optional)</label>
                        <input type="text" 
                               id="tags" 
                               class="form-control" 
                               placeholder="e.g., Python, Django, API">
                    </div>
                </div>
            </div>
            
            <button type="submit" class="btn-primary-custom" id="submitBtn">
                ‚úÖ Add Teaching Skill
            </button>
        </form>
    </div>

    <!-- My Skills Card -->
    <div class="card-custom">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="section-title mb-0" id="listSectionTitle">üìñ My Teaching Skills</h3>
            <button onclick="loadMySkills()" class="btn btn-outline-primary">
                üîÑ Refresh
            </button>
        </div>
        
        <div id="skillsContainer" class="skills-grid">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading your skills...</p>
            </div>
        </div>
    </div>
</div>

<script>
const API_BASE = window.location.origin;
const token = localStorage.getItem("token");
const role = (localStorage.getItem("role") || "").toLowerCase();
const MODE_META = {
  teach: {
    pageSubtitle: "Add skills you want to teach and manage your expertise",
    addSectionTitle: "‚ûï Add Teaching Skill",
    listSectionTitle: "üìñ My Teaching Skills",
    descriptionLabel: "Description",
    descriptionPlaceholder: "Describe what you'll teach...",
    submitLabel: "‚úÖ Add Teaching Skill",
    addingLabel: "Adding teaching skill...",
    emptyHint: "Add your first teaching skill using the form above",
    successMessage: `‚úÖ Teaching skill added successfully!<br><br>
      <a href="/static/recommendations.html" class="btn btn-primary btn-sm">ü§ñ Get AI Mentor Recommendations</a>`
  },
  learn: {
    pageSubtitle: "Add skills you want to learn and track your learning goals",
    addSectionTitle: "‚ûï Add Learning Skill",
    listSectionTitle: "üéØ My Learning Skills",
    descriptionLabel: "Learning Goal",
    descriptionPlaceholder: "Describe what you want to learn...",
    submitLabel: "‚úÖ Add Learning Skill",
    addingLabel: "Adding learning skill...",
    emptyHint: "Add your first learning skill using the form above",
    successMessage: `‚úÖ Learning skill added successfully!<br><br>
      <a href="/static/recommendations.html" class="btn btn-primary btn-sm">ü§ñ View AI Recommendations</a>`
  }
};

function normalizeSkillType(value) {
  const v = String(value || "").trim().toLowerCase();
  if (v === "offer") return "teach";
  if (v === "need") return "learn";
  return v === "learn" ? "learn" : "teach";
}

const modeFromQuery = new URLSearchParams(window.location.search).get("type");
let currentSkillType = normalizeSkillType(modeFromQuery);

// Check auth (allow both mentor and learner personas here).
if (!token) {
  alert("Please login to manage skills.");
  window.location.href = "/static/login.html";
}
if (role === "admin") {
  alert("Admins cannot manage teaching/learning skills.");
  window.location.href = "/admin/dashboard";
}

function applyModeToUi() {
  const meta = MODE_META[currentSkillType];
  document.getElementById("pageSubtitle").textContent = meta.pageSubtitle;
  document.getElementById("addSectionTitle").textContent = meta.addSectionTitle;
  document.getElementById("listSectionTitle").textContent = meta.listSectionTitle;
  document.getElementById("descriptionLabel").innerHTML = `${meta.descriptionLabel} <span class="required">*</span>`;
  document.getElementById("description").placeholder = meta.descriptionPlaceholder;
  document.getElementById("submitBtn").textContent = meta.submitLabel;
  document.getElementById("teachModeBtn").classList.toggle("active", currentSkillType === "teach");
  document.getElementById("learnModeBtn").classList.toggle("active", currentSkillType === "learn");
}

function switchSkillMode(mode) {
  const nextMode = normalizeSkillType(mode);
  if (nextMode === currentSkillType) return;
  currentSkillType = nextMode;
  const url = new URL(window.location.href);
  url.searchParams.set("type", currentSkillType);
  window.history.replaceState({}, "", url.toString());
  applyModeToUi();
  loadMySkills();
}

// Initialize
window.onload = async () => {
  applyModeToUi();
  await loadMySkills();
  await checkPendingRequests();
  setInterval(checkPendingRequests, 30000);
};

// Check for pending session requests
async function checkPendingRequests() {
  try {
    const response = await fetch(`${API_BASE}/sessions/pending`, {
      headers: { "Authorization": `Bearer ${token}` }
    });
    
    if (response.ok) {
      const sessions = await response.json();
      const badge = document.getElementById("notificationBadge");
      
      if (sessions.length > 0) {
        badge.textContent = sessions.length;
        badge.classList.remove("hidden");
      } else {
        badge.classList.add("hidden");
      }
    }
  } catch (error) {
    console.error("Error checking notifications:", error);
  }
}

// Check notifications (redirect to sessions page)
function checkNotifications() {
  window.location.href = "/static/sessions.html";
}

// Load my skills for current mode (teach/learn)
async function loadMySkills() {
  const container = document.getElementById("skillsContainer");
  container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading...</p></div>';

  try {
    const res = await fetch(`${API_BASE}/skills/my/${currentSkillType}`, {
      headers: { "Authorization": `Bearer ${token}` }
    });

    if (!res.ok) {
      if (res.status === 401) {
        alert("Session expired. Please log in again.");
        window.location.href = "/static/login.html";
        return;
      }
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }

    const skills = await res.json();
    displaySkills(skills);
  } catch (error) {
    console.error("Load skills error:", error);
    document.getElementById("skillsContainer").innerHTML = `
      <div class="alert alert-danger">
        ‚ùå Failed to load skills. Please refresh or log in again.
      </div>
    `;
  }
}

// Display skills
function displaySkills(skills) {
  const container = document.getElementById("skillsContainer");

  if (skills.length === 0) {
    const meta = MODE_META[currentSkillType];
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">üìö</div>
        <h4>No Skills Added Yet</h4>
        <p>${meta.emptyHint}</p>
      </div>
    `;
    return;
  }

  container.innerHTML = skills.map(skill => `
    <div class="skill-item">
      <div class="skill-info">
        <h5>${skill.title}</h5>
        <div class="skill-meta">
          <span class="skill-badge badge-category">${skill.category}</span>
          <span class="skill-badge badge-level">${skill.proficiency_level}</span>
        </div>
        <p class="skill-description">${skill.description}</p>
        ${skill.tags && skill.tags.length > 0 ? `<p class="skill-description"><strong>Tags:</strong> ${skill.tags.join(', ')}</p>` : ''}
      </div>
      <div class="skill-actions">
        <!-- ‚úÖ skill.id = UserSkill.id (correct for DELETE endpoint) -->
        <button onclick="deleteSkill(${skill.id})" class="btn-delete" title="Delete">
          üóëÔ∏è
        </button>
      </div>
    </div>
  `).join('');
}

// Add skill form submission
document.getElementById("addSkillForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const formData = new FormData();
  formData.append("title", document.getElementById("skillName").value.trim());
  formData.append("description", document.getElementById("description").value.trim());
  formData.append("category", document.getElementById("category").value);
  formData.append("proficiency_level", document.getElementById("proficiencyLevel").value);
  formData.append("skill_type", currentSkillType);

  const tagsInput = document.getElementById("tags").value.trim();
  if (tagsInput) {
    const tags = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag);
    tags.forEach(tag => formData.append("tags", tag));
  }

  const submitBtn = document.getElementById("submitBtn");
  submitBtn.disabled = true;
  submitBtn.textContent = MODE_META[currentSkillType].addingLabel;

  try {
    const response = await fetch(`${API_BASE}/skills/`, {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${token}`
        // ‚úÖ NO Content-Type header ‚Äî let browser set multipart/form-data
      },
      body: formData
    });

    if (!response.ok) {
      const err = await response.json().catch(() => ({ detail: "Unknown error" }));
      throw new Error(err.detail || `HTTP ${response.status}`);
    }

    showAlert(MODE_META[currentSkillType].successMessage, "success", true);
    document.getElementById("addSkillForm").reset();
    applyModeToUi();
    await loadMySkills();
  } catch (error) {
    console.error("Add skill error:", error);
    showAlert(`‚ùå ${error.message}`, "danger");
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = MODE_META[currentSkillType].submitLabel;
  }
});

// Delete skill
async function deleteSkill(skillId) {
  if (!confirm("‚ö†Ô∏è Are you sure you want to remove this skill? This cannot be undone.")) {
    return;
  }

  try {
    const response = await fetch(`${API_BASE}/skills/${skillId}`, {
      method: "DELETE",
      headers: { "Authorization": `Bearer ${token}` }
    });

    if (!response.ok) {
      const err = await response.json().catch(() => ({ detail: "Delete failed" }));
      throw new Error(err.detail || `HTTP ${response.status}`);
    }

    showAlert("‚úÖ Skill removed successfully!", "success");
    await loadMySkills();
  } catch (error) {
    console.error("Delete skill error:", error);
    showAlert(`‚ùå ${error.message}`, "danger");
  }
}

// Show alert
function showAlert(message, type = 'danger', allowHtml = false) {
  const alertBox = document.getElementById("alertBox");
  alertBox.className = `alert alert-${type} show`;
  if (allowHtml) {
    alertBox.innerHTML = message;
  } else {
    alertBox.textContent = message;
  }
  
  setTimeout(() => {
    alertBox.classList.remove('show');
  }, 5000);
}

// Logout
function logout() {
  localStorage.clear();
  window.location.href = "/static/login.html";
}
</script>

</body>
</html>
